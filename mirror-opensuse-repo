#!/bin/sh

# Mirrors the opensuse distribution. Meant to be run daily.
#
#  -- m.barnaba@ifad.org  Tue Feb 19 19:52:47 CET 2013
#  -- m.barnaba@ifad.org  Tue Jan  7 19:07:55 CET 2014
#
MIRROR_DIR=/srv/opensuse
RSYNC=/usr/bin/rsync

if [ `id -u` -eq 0 ]; then
  echo "Please do not run this as root. Use the 'mirror' user."
  exit -1
fi

LOCK=/var/lock/`basename $0`.lock
if ! lockfile -l 14400 -r 0 $LOCK; then
  echo "Another process is already running. Aborting."
  exit 1
fi

echo
echo "--------------------------------------------------------------"
echo "`date` - OpenSuSE mirror started"

# Exclude 11.4 to avoid having it deleted, and exclude:
#
# * repositories/ fetched by mirror-buildservice-repo
# * evergreen/    fetched by mirror-evergreen-repo
#
$RSYNC --verbose --human-readable        \
     --recursive --links --perms --times      \
     --itemize-changes --stats --delete-after \
     --exclude='ports/'                       \
     --exclude='evergreen/'                   \
     --exclude='repositories/'                \
     --exclude='update/11.0/'                 \
     --exclude='update/11.1/'                 \
     --exclude='update/11.2/'                 \
     --exclude='update/11.3/'                 \
     --exclude='update/11.4/'                 \
     --exclude='distribution/11.0/'           \
     --exclude='distribution/11.1/'           \
     --exclude='distribution/11.2/'           \
     --exclude='distribution/11.3/'           \
     --exclude='distribution/11.4/'           \
     rsync.opensuse.org::opensuse-full/opensuse/ $MIRROR_DIR

ret=$?

echo "`date` - OpenSuSE mirror completed with status $ret"
echo "--------------------------------------------------------------"
echo

# Update URLs in .repo files in update/ repos
ls -1 $MIRROR_DIR/update/*/*.repo |
  xargs sed -i 's#download.opensuse.org#packages.ifad.org#'

# Update URLs in content.xml files in distribution/ repos
ls -1 $MIRROR_DIR/distribution/*/repo/*/control.xml |
  xargs sed -i \
  -e 's#http://download.opensuse.org/update/#http://packages.ifad.org/update/#' \
  -e 's#http://download.opensuse.org/distribution/#http://packages.ifad.org/distribution/#'

rm -f $LOCK

exit $ret
